#!/usr/bin/env bash

# ops installer
# This script installs ops to your system

set -euo pipefail

display_error() {
	tput sgr0
	tput setaf 1
	echo "ERROR: $1" >&2
	tput sgr0
	exit 1
}

display_success() {
	tput sgr0
	tput setaf 2
	echo "$1"
	tput sgr0
}

update_profile() {
	[ -f "$1" ] || return 1

	# Check if the source line already exists
	grep -F "$source_line" "$1" > /dev/null 2>&1
	if [ $? -ne 0 ]; then
		echo "" >> "$1"
		echo "# ops" >> "$1"
		echo "$source_line" >> "$1"
		return 0
	fi
	return 1
}

# Default values
# Default to 'main' branch (modern standard), fallback to 'master' if needed
INSTALL_DIR=${2:-/usr/local/bin}
SRC_REPO=${SRC_REPO:-https://github.com/berttejeda/bert.ops-command.git}
TEMP_DIR=$(mktemp -d)

# If branch is explicitly provided, use it
# Otherwise, try 'main' first, then fallback to 'master'
if [ -n "${1:-}" ]; then
	BRANCH="$1"
else
	# Try to detect which branch exists
	echo "Detecting default branch..."
	if git ls-remote --heads --exit-code "$SRC_REPO" main &> /dev/null; then
		BRANCH="main"
		echo "Using 'main' branch"
	elif git ls-remote --heads --exit-code "$SRC_REPO" master &> /dev/null; then
		BRANCH="master"
		echo "Using 'master' branch (fallback)"
	else
		# Default to main if we can't detect
		BRANCH="main"
		echo "Defaulting to 'main' branch"
	fi
fi

# Cleanup function
cleanup() {
	rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

# Check if ops is already installed
if command -v ops &> /dev/null; then
	display_error "ops is already installed at $(which ops)

To reinstall, first remove the existing installation:
  rm $(which ops)
  rm -rf ~/ops-command"
fi

# Check for required tools
[ -z "$(which git)" ] && display_error "Could not find git

  debian/ubuntu: apt-get install git
  redhat/centos: yum install git
  archlinux: pacman -S git
  mac:   brew install git
"

[ -z "$(which yq)" ] && display_error "Could not find yq

  mac:   brew install yq
  debian/ubuntu: apt-get install yq
  redhat/centos: yum install yq
  Or download from: https://github.com/mikefarah/yq
"

# Check if we're running from a git repository
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo "")

if [[ -n "$GIT_ROOT" && "$(basename "$GIT_ROOT")" == "bert.ops-command" ]]; then
	# We're in the ops repository, use local files
	echo "Using local repository at $GIT_ROOT"
	REPO_DIR="$GIT_ROOT"
else
	# Clone the repository
	echo "Cloning from $SRC_REPO (branch: $BRANCH)"
	if ! git clone --quiet --branch "$BRANCH" "$SRC_REPO" "$TEMP_DIR/repo" 2> /dev/null; then
		# If the specified branch doesn't exist, try the other common branch
		if [ "$BRANCH" = "main" ]; then
			echo "Branch 'main' not found, trying 'master'..."
			BRANCH="master"
			git clone --quiet --branch "$BRANCH" "$SRC_REPO" "$TEMP_DIR/repo" 2> /dev/null ||
				display_error "Failed to clone from $SRC_REPO (tried branches: main, master)"
		elif [ "$BRANCH" = "master" ]; then
			echo "Branch 'master' not found, trying 'main'..."
			BRANCH="main"
			git clone --quiet --branch "$BRANCH" "$SRC_REPO" "$TEMP_DIR/repo" 2> /dev/null ||
				display_error "Failed to clone from $SRC_REPO (tried branches: master, main)"
		else
			display_error "Failed to clone branch '$BRANCH' from $SRC_REPO"
		fi
	fi
	REPO_DIR="$TEMP_DIR/repo"
fi

# Check if ops script exists
if [ ! -f "$REPO_DIR/ops" ]; then
	display_error "ops script not found in repository"
fi

# Create install directory if it doesn't exist
if [ ! -d "$INSTALL_DIR" ]; then
	echo "Creating installation directory: $INSTALL_DIR"
	mkdir -p "$INSTALL_DIR" 2>/dev/null || display_error "Failed to create $INSTALL_DIR (may need sudo)"
fi

# Check if we can write to install directory
if [ ! -w "$INSTALL_DIR" ]; then
	echo "Installation directory requires sudo privileges"
	SUDO_CMD="sudo"
else
	SUDO_CMD=""
fi

# Copy ops script to install directory
echo "Installing ops to $INSTALL_DIR"
$SUDO_CMD cp "$REPO_DIR/ops" "$INSTALL_DIR/ops"
$SUDO_CMD chmod +x "$INSTALL_DIR/ops"

# Verify installation
if ! command -v ops &> /dev/null; then
	# ops might not be in PATH yet
	if [ -f "$INSTALL_DIR/ops" ]; then
		display_success "ops installed to $INSTALL_DIR/ops"
		echo ""
		echo "Note: $INSTALL_DIR may not be in your PATH."
		echo "Add it to your PATH or use: $INSTALL_DIR/ops"
	else
		display_error "Installation failed - ops not found in $INSTALL_DIR"
	fi
else
	display_success "ops installed successfully to $(which ops)"
fi

# Initialize ops
echo ""
echo "Initializing ops..."
if command -v ops &> /dev/null; then
	ops ---init 2>&1 | grep -v "^[0-9]\{12\} INFO:" || true
else
	"$INSTALL_DIR/ops" ---init 2>&1 | grep -v "^[0-9]\{12\} INFO:" || true
fi

# Set up shell profile updates
source_line="export PATH=\"$INSTALL_DIR:\$PATH\""

# Determine which profile files to update
PROFILES_UPDATED=0

if [ -f "$HOME/.zshrc" ]; then
	if update_profile "$HOME/.zshrc"; then
		PROFILES_UPDATED=$((PROFILES_UPDATED + 1))
		echo "Updated ~/.zshrc"
	fi
fi

if [ "$(uname)" == "Linux" ]; then
	if [ -f "$HOME/.bashrc" ]; then
		if update_profile "$HOME/.bashrc"; then
			PROFILES_UPDATED=$((PROFILES_UPDATED + 1))
			echo "Updated ~/.bashrc"
		fi
	elif [ -f "$HOME/.bash_profile" ]; then
		if update_profile "$HOME/.bash_profile"; then
			PROFILES_UPDATED=$((PROFILES_UPDATED + 1))
			echo "Updated ~/.bash_profile"
		fi
	fi
elif [ "$(uname)" == "Darwin" ]; then
	# macOS detection
	if [ -f "$HOME/.zshrc" ]; then
		# Already handled above
		:
	elif [ -f "$HOME/.profile" ]; then
		if update_profile "$HOME/.profile"; then
			PROFILES_UPDATED=$((PROFILES_UPDATED + 1))
			echo "Updated ~/.profile"
		fi
	elif [ -f "$HOME/.bash_profile" ]; then
		if update_profile "$HOME/.bash_profile"; then
			PROFILES_UPDATED=$((PROFILES_UPDATED + 1))
			echo "Updated ~/.bash_profile"
		fi
	fi
fi

# Summary
echo ""
display_success "Installation complete!"
echo ""
echo "ops has been installed and initialized."
echo ""

if [ $PROFILES_UPDATED -eq 0 ]; then
	echo "Unable to automatically update shell profile files."
	echo ""
	echo "Please manually add the following to your shell configuration file"
	echo "($HOME/.bashrc, $HOME/.zshrc, or $HOME/.profile):"
	echo ""
	echo "  $source_line"
	echo ""
fi

echo "To get started:"
echo "  1. Reload your shell: source ~/.bashrc  (or source ~/.zshrc)"
echo "  2. Scan a directory: ops ---scan /path/to/scripts"
echo "  3. View commands: ops ---help"
echo "  4. Install completion: ops ---completion"
echo ""

